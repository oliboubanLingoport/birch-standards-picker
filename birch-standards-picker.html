<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../birch-typeahead/birch-typeahead.html">
<link rel="import" href="../oak-i18n-behavior/oak-i18n-behavior.html">
<link rel="import" href="../wc-i18n/wc-i18n.html">

<!--
The standards picker is used to select standard dates and places.

Assumptions the component makes
- fetch and promises are supported (the component does not bring in the polyfills)
- `/tree-data/` resolves to a valid tree-data path e.g. `integration.familysearch.org/tree-data` (you'll need a proxy for tree-data running locally)
- user is logged in to familysearch (`tree-data` returns 401s)

Behavior of the component
- When a user types a standard then clicks away or presses escape without selecting from the input menu, no standard is selected
- When a user presses enter after typing, the first standard will be selected (The first standard keeps the original text the user typed and uses the first standard in the list for its standardizied values)
- The input menu will reappear when the user presses the down arrow while focused on the input field
- If the user selects a standard from the input menu, it will change the text in the input field
- If the user types fast and then quickly presses enter before the call to get the standards can come back, no standard will be selected, and when the call finishes the input menu will appear (unless the input field loses focus)
- When the standard is changed from the dropdown menu, if the text in the input field matched the text of the previously selected standard the input field is updated to match the new standard

Example:

    <birch-standards-picker standard-type="place"></birch-standards-picker>

@demo demo/index.html

-->

<dom-module id="birch-standards-picker">
  <template>
    <wc-i18n-src locale='[[lang]]' domain='birch-standards-picker' locale-dir='[[localeDir()]]'></wc-i18n-src>
    <wc-i18n id='x1' provider key="birch-standards-picker.PLACE_PLACEHOLDER" value="{{_i18n_PLACE_PLACEHOLDER}}"></wc-i18n>
    <wc-i18n provider key="birch-standards-picker.DATE_PLACEHOLDER" value="{{_i18n_DATE_PLACEHOLDER}}"></wc-i18n>
    <wc-i18n provider key="birch-standards-picker.NO_STANDARD_DATE_AVAILABLE" value="{{_i18n_NO_STANDARD_DATE_AVAILABLE}}"></wc-i18n>
    <wc-i18n provider key="birch-standards-picker.NO_STANDARD_PLACE_AVAILABLE" value="{{_i18n_NO_STANDARD_PLACE_AVAILABLE}}"></wc-i18n>
    <wc-i18n provider key="birch-standards-picker.NO_STANDARD_SELECTED" value="{{_i18n_NO_STANDARD_SELECTED}}"></wc-i18n>
    <wc-i18n provider key="birch-standards-picker.EVENT_DATE_LABEL" value="{{_i18n_EVENT_DATE_LABEL}}"></wc-i18n>
    <wc-i18n provider key="birch-standards-picker.EVENT_PLACE_LABEL" value="{{_i18n_EVENT_PLACE_LABEL}}"></wc-i18n>
    <wc-i18n provider key="birch-standards-picker.STANDARD_DATE_LABEL" value="{{_i18n_STANDARD_DATE_LABEL}}"></wc-i18n>
    <wc-i18n provider key="birch-standards-picker.STANDARD_PLACE_LABEL" value="{{_i18n_STANDARD_PLACE_LABEL}}"></wc-i18n>
    <style>
      :host {
        display: block;
        font-family: Verdana;
        color: #666662;
      }
      [hidden] {
        display: none !important;
      }
      .standard_label {
        font-size: 12px;
        color: #666662;
        display: block;
        padding: 2px
      }
      .standard-container {
        position: relative;
        max-width: 300px;
      }
      .standard-container p {
        margin: 0;
        padding-top: 10px;
        min-height: 40px;
      }
      #optionsMenu {
        position: absolute;
        z-index: 100000;
        padding: 0;
        width: 100%;
        max-height: 200px;
        overflow-y: scroll;
        overflow-x: hidden;
        cursor: pointer;
        box-shadow: 0 5px 10px #bab7b1;
        -webkit-overflow-scrolling: touch;
        border: 1px solid #bab7b1;
        border-radius: 4px;
      }
      #optionsMenuWrapper {
        position: relative;
        margin-top: 12px;
      }
      #optionsMenuWrapper:after, #optionsMenuWrapper:before {
        bottom: -1px;
        left: 30px;
        border: solid transparent;
        content: " ";
        height: 0;
        width: 0;
        position: absolute;
        pointer-events: none;
      }
      #optionsMenuWrapper:after {
        border-color: rgba(255, 255, 255, 0);
        border-bottom-color: #ffffff;
        border-width: 12px;
        margin-left: -12px;
        z-index: 100001;
      }
      #optionsMenuWrapper:before {
        border-color: rgba(186, 183, 177, 0);
        border-bottom-color: #bab7b1;
        border-width: 13px;
        margin-left: -13px;
      }
      .label-text {
        padding-left: 2px;
        max-width: 265px;
        overflow: hidden;
        display: inline-block;
        text-overflow: ellipsis;
        vertical-align: middle;
      }
      .carat {
        vertical-align: top;
      }
      .standard-button {
        border: none;
        vertical-align: middle;
        white-space: nowrap;
        background: 0 0;
        font-size: 14px;
        padding: 0;
        padding-left: 2px;
        max-width: 300px;
        overflow: hidden;
      }
      .standard-button:active,
      .standard-button:focus,
      .standard-button:hover {
        border:none;
        outline:none;

      }
      #Layer_1 {
        vertical-align: middle;
      }
      birch-typeahead {
        --birch-typeahead-input: {
          background-color: #fff;
          border: 1px solid #ccc;
          border-radius: 4px;
          box-shadow: inset 0 3px 0 rgba(0,0,0,.05);
          box-sizing: border-box;
          color: #333331;
          padding: 6px 10px;
        }
      }
      paper-item, paper-icon-item, paper-item-body {
        --paper-item: {
          font-family: verdana;
          font-size: 14px;
        };
        --paper-item-selected: {
          font-weight: 100 !important;
          background-color: #ecebea !important;
        };
        --paper-item-icon-width: 25px;
      }
      paper-menu {
        --paper-menu: {
          font-family: verdana
        };
      }
      paper-item > *, paper-icon-item > *, paper-item-body > * {
        white-space: normal !important;
        font-size: 14px !important;
      }
    </style>
    <label class="standard_label" for="typeahead" hidden$='[[hideInputLabel]]'>[[inputLabel]]</label>
    <birch-typeahead
      id='typeahead'
      on-birch-typeahead:input='_handleChange'
      on-birch-typeahead:cancel='_handleCancel'
      on-birch-typeahead:blur='_handleCancel'
      on-birch-typeahead:selected='_handleSelect'
      highlight-first-item
      value="[[_searchTerm]]"
      placeholder="[[_getPlaceholder(standardType, _i18n_DATE_PLACEHOLDER, _i18n_PLACE_PLACEHOLDER)]]">
      <template>
        <template is="dom-if" if="[[item.icon]]" restamp>

          <paper-icon-item>
            <iron-icon item-icon>
              <template is="dom-if" if="[[isDate]]">
                <svg id="Layer_1" data-name="Layer 1" width="14" height="16" viewBox="0 0 14 16"><path d="M1,15.9A.94.94,0,0,1,.1,15V3.6A1.5,1.5,0,0,1,1.6,2.1h.3V3A1.1,1.1,0,0,0,3,4.1h.1V.1H4a.9.9,0,0,1,.9.9V2.1h4V3A1.1,1.1,0,0,0,10,4.1h.1V.1H11a.9.9,0,0,1,.9.9V2.1h.5a1.5,1.5,0,0,1,1.5,1.5V15a.94.94,0,0,1-.94.94Zm.86-1.8H12.1V5.9H1.9Z" style="fill:#333331"/><rect width="14" height="16" style="fill:none"/><path d="M3.17,12.24l.59-.76a2.12,2.12,0,0,0,1.47.61c.65,0,1-.28,1-.68s-.33-.62-1.07-.62l-.66,0v-1h.66c.59,0,1-.18,1-.57s-.43-.63-1-.63a1.92,1.92,0,0,0-1.35.55l-.57-.71a2.63,2.63,0,0,1,2-.85c1.25,0,2,.56,2,1.45a1.31,1.31,0,0,1-1.17,1.22,1.34,1.34,0,0,1,1.25,1.28c0,.92-.82,1.57-2.1,1.57A2.67,2.67,0,0,1,3.17,12.24Z" style="fill:#333331"/><path d="M9.33,13V9.13l-.89.9-.65-.68L9.47,7.67h1V13Z" style="fill:#333331"/></svg>
              </template>
              <template is="dom-if" if="[[isPlace]]">
                <svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" width="11" height="16" viewBox="0 0 11 16"><path d="M5.5,15.79a.39.39,0,0,1-.37-.24.36.36,0,0,1,0-.13A7.49,7.49,0,0,0,2.9,10.31c-.37-.44-.79-.94-1.27-1.57L1.4,8.42a5,5,0,0,1-1-3.08,5.13,5.13,0,1,1,10.27,0,5.08,5.08,0,0,1-1,3.08l-.24.32h0c-.48.63-.9,1.13-1.27,1.57a7.46,7.46,0,0,0-2.21,5.08A.39.39,0,0,1,5.5,15.79ZM5.5,3a2,2,0,1,0,2,2A2,2,0,0,0,5.5,3Z" style="fill:#333331"/><rect width="11" height="16" style="fill:none"/></svg>
              </template>
            </iron-icon>
            <paper-item-body two-line>
              <div class="standard-label" style="white-space:normal;color:#333331;font-weight:bold;">[[item.label]]</div>
              <div class="standard-info" style="white-space:normal;color:#666662;font-size:12px !important;">[[item.type]][[item.yearRange]]</div>
            </paper-item-body>
          </paper-icon-item>
        </template>

        <template is="dom-if" if="[[!item.icon]]" restamp>
          <paper-icon-item>
            <iron-icon item-icon></iron-icon>
            <paper-item-body two-line>
              <div class="standard-label" style="white-space:normal;color:#333331;">[[item.label]]</div>
              <div class="standard-info" style="white-space:normal;color:#666662;font-size:12px !important;">[[item.type]][[item.yearRange]]</div>
            </paper-item-body>
          </paper-icon-item>
        </template>
      </template>
    </birch-typeahead>
    <div class="standard-container" hidden$='[[hideStandardsDropdown]]'>
      <p><label id="label" class='standard_label'>[[standardsDropdownLabel]]</label>
        <button id="button" class="standard-button" on-blur="_handleBlur" on-tap="_openStandardSelector" on-keydown="_handleKeydown" hidden$=[[!_standardLabel]]>
          <iron-icon class="standardIcon">
            <template is="dom-if" if="[[isDate]]">
              <svg id="Layer_1" data-name="Layer 1" width="14" height="16" viewBox="0 0 14 16"><path d="M1,15.9A.94.94,0,0,1,.1,15V3.6A1.5,1.5,0,0,1,1.6,2.1h.3V3A1.1,1.1,0,0,0,3,4.1h.1V.1H4a.9.9,0,0,1,.9.9V2.1h4V3A1.1,1.1,0,0,0,10,4.1h.1V.1H11a.9.9,0,0,1,.9.9V2.1h.5a1.5,1.5,0,0,1,1.5,1.5V15a.94.94,0,0,1-.94.94Zm.86-1.8H12.1V5.9H1.9Z" style="fill:#333331"/><rect width="14" height="16" style="fill:none"/><path d="M3.17,12.24l.59-.76a2.12,2.12,0,0,0,1.47.61c.65,0,1-.28,1-.68s-.33-.62-1.07-.62l-.66,0v-1h.66c.59,0,1-.18,1-.57s-.43-.63-1-.63a1.92,1.92,0,0,0-1.35.55l-.57-.71a2.63,2.63,0,0,1,2-.85c1.25,0,2,.56,2,1.45a1.31,1.31,0,0,1-1.17,1.22,1.34,1.34,0,0,1,1.25,1.28c0,.92-.82,1.57-2.1,1.57A2.67,2.67,0,0,1,3.17,12.24Z" style="fill:#333331"/><path d="M9.33,13V9.13l-.89.9-.65-.68L9.47,7.67h1V13Z" style="fill:#333331"/></svg>
            </template>
            <template is="dom-if" if="[[isPlace]]">
              <svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" width="11" height="16" viewBox="0 0 11 16"><path d="M5.5,15.79a.39.39,0,0,1-.37-.24.36.36,0,0,1,0-.13A7.49,7.49,0,0,0,2.9,10.31c-.37-.44-.79-.94-1.27-1.57L1.4,8.42a5,5,0,0,1-1-3.08,5.13,5.13,0,1,1,10.27,0,5.08,5.08,0,0,1-1,3.08l-.24.32h0c-.48.63-.9,1.13-1.27,1.57a7.46,7.46,0,0,0-2.21,5.08A.39.39,0,0,1,5.5,15.79ZM5.5,3a2,2,0,1,0,2,2A2,2,0,0,0,5.5,3Z" style="fill:#333331"/><rect width="11" height="16" style="fill:none"/></svg>
            </template>
          </iron-icon>
          <span class="label-text">[[_standardLabel]]</span><span class="carat"> â–¾</span>
        </button>
      </p>
      <div id="optionsMenuWrapper" tabindex="-1" hidden$="[[_hideStandards]]">
        <paper-menu id="optionsMenu" tabindex="-1" hidden$="[[_hideStandards]]">
          <template is="dom-repeat" items="[[_options]]">
            <template is="dom-if" if="[[item.icon]]">

              <paper-icon-item on-tap="_handleChangeStandard">
                <iron-icon item-icon>
                  <template is="dom-if" if="[[isDate]]">
                    <svg id="Layer_1" data-name="Layer 1" width="14" height="16" viewBox="0 0 14 16"><path d="M1,15.9A.94.94,0,0,1,.1,15V3.6A1.5,1.5,0,0,1,1.6,2.1h.3V3A1.1,1.1,0,0,0,3,4.1h.1V.1H4a.9.9,0,0,1,.9.9V2.1h4V3A1.1,1.1,0,0,0,10,4.1h.1V.1H11a.9.9,0,0,1,.9.9V2.1h.5a1.5,1.5,0,0,1,1.5,1.5V15a.94.94,0,0,1-.94.94Zm.86-1.8H12.1V5.9H1.9Z" style="fill:#333331"/><rect width="14" height="16" style="fill:none"/><path d="M3.17,12.24l.59-.76a2.12,2.12,0,0,0,1.47.61c.65,0,1-.28,1-.68s-.33-.62-1.07-.62l-.66,0v-1h.66c.59,0,1-.18,1-.57s-.43-.63-1-.63a1.92,1.92,0,0,0-1.35.55l-.57-.71a2.63,2.63,0,0,1,2-.85c1.25,0,2,.56,2,1.45a1.31,1.31,0,0,1-1.17,1.22,1.34,1.34,0,0,1,1.25,1.28c0,.92-.82,1.57-2.1,1.57A2.67,2.67,0,0,1,3.17,12.24Z" style="fill:#333331"/><path d="M9.33,13V9.13l-.89.9-.65-.68L9.47,7.67h1V13Z" style="fill:#333331"/></svg>
                  </template>
                  <template is="dom-if" if="[[isPlace]]">
                    <svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" width="11" height="16" viewBox="0 0 11 16"><path d="M5.5,15.79a.39.39,0,0,1-.37-.24.36.36,0,0,1,0-.13A7.49,7.49,0,0,0,2.9,10.31c-.37-.44-.79-.94-1.27-1.57L1.4,8.42a5,5,0,0,1-1-3.08,5.13,5.13,0,1,1,10.27,0,5.08,5.08,0,0,1-1,3.08l-.24.32h0c-.48.63-.9,1.13-1.27,1.57a7.46,7.46,0,0,0-2.21,5.08A.39.39,0,0,1,5.5,15.79ZM5.5,3a2,2,0,1,0,2,2A2,2,0,0,0,5.5,3Z" style="fill:#333331"/><rect width="11" height="16" style="fill:none"/></svg>
                  </template>
                </iron-icon>
                <paper-item-body two-line>
                  <div class="standard-label" style="white-space:normal;color:#333331;font-weight:bold;">[[item.label]]</div>
                  <div class="standard-info" style="white-space:normal;color:#666662;font-size:12px !important;">[[item.type]][[item.yearRange]]</div>
                </paper-item-body>
              </paper-icon-item>
            </template>
            <template is="dom-if" if="[[!item.icon]]">
              <paper-icon-item on-tap="_handleChangeStandard">
                <iron-icon item-icon></iron-icon>
                <paper-item-body two-line>
                  <div class="standard-label" style="white-space:normal;color:#333331;">[[item.label]]</div>
                  <div class="standard-info" style="white-space:normal;color:#666662;font-size:12px !important;">[[item.type]][[item.yearRange]]</div>
                </paper-item-body>
              </paper-icon-item>
            </template>
          </template>
        </paper-menu>
      </div>
    </div>
  </template>
  <script>
    Polymer({
      is: 'birch-standards-picker',
      behaviors: [
        OakI18nBehavior,
        WCI18nBehavior
      ],
      properties: {
        /**
         * The label for the input box.
         * The default will be the translation for 'Event [type]'
         *
         * @type {String}
         */
        inputLabel: {
          type: String,
          value: ''
        },

        /**
         * Whether to hide the standards selector dropdown
         *
         * @type{Boolean}
         */
        hideStandardsDropdown: {
          type: Boolean,
          value: false
        },

        /**
         * Whether to hide the label above the input box
         *
         * @type{Boolean}
         */
        hideInputLabel: {
          type: Boolean,
          value: false
        },

        /**
         * The label for the standard selector.
         * The default will be the translation for 'Standardized Event [type]'
         *
         * @type {String}
         */
        standardsDropdownLabel: {
          type: String,
          value: ''
        },

        /**
         * The text that the user has typed in.
         *
         * @type {String}
         */
        originalText: {
          type: String,
          value: '',
          notify: true
        },

        /**
         * The display label for the standard selected.
         *
         * @type {String}
         */
        _standardLabel: {
          type: String,
          value: '',
          notify: true
        },

        /**
         * The text value of the standard.
         *
         * @type {String}
         */
        standardText: {
          type: String,
          value: '',
          notify: true
        },

        /**
         * The julian date range of the standard
         *
         * @type {Object}
         */
        julianDateRange: {
          type: Object,
          value: function() {
            return null;
          },
          notify: true
        },

        /**
         * The type of standard to fetch.
         *
         * Valid values are: `date`, `place`
         * @type {String}
         */
        standardType: {
          type: String,
          value: 'date'
        },

        /**
         * The id of the standard
         *
         * @type {String}
         */
        standardId: {
          type: String,
          value: ''
        },

        _searchTerm: {
          type: String,
          value: ''
        },

        _options: {
          type: Array,
          value: function() {
            return [];
          }
        },

        _hideStandards: {
          type: Boolean,
          value: true
        },

        _stopSearch: {
          type: Boolean,
          value: false
        }
      },

      observers: [
        '_updateOptions(_searchTerm, standardType, lang)',
        '_updateLabels(_i18n_STANDARD_PLACE_LABEL, _i18n_STANDARD_DATE_LABEL, _i18n_EVENT_PLACE_LABEL, _i18n_EVENT_DATE_LABEL, standardType)',
        '_setIsDateOrPlace(standardType)'
      ],

      ready: function() {
        this.$.typeahead.$.input.addEventListener('keydown', this._handleDownArrowForTypeahead.bind(this));
      },

      _updateLabels: function(standardPlaceLabel, standardDateLabel, eventPlaceLabel, eventDateLabel, standardType) {
        this.standardsDropdownLabel = this.standardsDropdownLabel || this['_i18n_STANDARD_' + this.standardType.toUpperCase() + '_LABEL'];
        this.inputLabel = this.inputLabel || this['_i18n_EVENT_' + this.standardType.toUpperCase() + '_LABEL'];
      },

      _updateOptions: function(searchTerm, type, lang) {
        this._optionstoUseWhenNoChange = null;
        this._latestSearch = searchTerm;
        if (!searchTerm) return;
        return this._fetchOptions(searchTerm, type, lang).then(function(options) {
          // don't do anything with the response if it came back after they typed something again
          if (searchTerm !== this._latestSearch) return;
          if (!this._stopSearch) this.$.typeahead.options = options;
          // we stop the search a) when we select a standard from the typeahead menu since it will
          // update the input value and we don't want the menu to open up again and b) when we
          // choose a new standard from the dropdown menu and that causes us to change the text
          // in the input field as well.
          if (this._stopSearch) this._optionstoUseWhenNoChange = options;
          this._stopSearch = false;
          this.$.typeahead.loading = false;
        }.bind(this)).catch(function(err) {
          console.log(err);
          // don't do anything with the response if it came back after they typed something again
          if (searchTerm !== this._latestSearch) return;
          this._stopSearch = false;
          this.$.typeahead.loading = false;
        }.bind(this));
      },

      _fetchOptions: function(searchTerm, type, lang) {
        return new Promise(function(resolve, reject) {
          fetch('/tree-data/authorities/' + type + '?term=' + searchTerm + '&locale=' + lang, {
            credentials: 'same-origin'
          }).then(function(res) {
            return res.json();
          }.bind(this)).then(function(data) {
            if (!Array.isArray(data)) data = [];
            // Map the data to our desired format
            data = data.map(function(standard) {
              var vm = {
                icon: true,
                id: standard.id,
                label: standard.label,
                standardLabel: standard.label,
                standardText: standard.value,
                type: standard.type,
                yearRange: standard.yearRange,
                julianDateRange: standard.earliestAstro || standard.latestAstro ? {
                  earliestDay: standard.earliestAstro || standard.latestAstro,
                  latestDay: standard.latestAstro || standard.earliestAstro
                } : null,
                customText: null
              };
              // we display type and year next to each other with a comma between them, so
              // if we have both, we're going to put in the comma here since it's easier
              // than doing a dom-if for a comma and a space.
              if (vm.type && vm.yearRange) vm.type = vm.type + ', ';
              return vm;
            });

            this._options = data;
            this._optionsChanged = true;

            var noStandard = {
              icon: false,
              id: '',
              label: searchTerm,
              standardLabel: this['_i18n_NO_STANDARD_' + this.standardType.toUpperCase() + '_AVAILABLE'],
              standardText: '',
              type: null,
              customText: searchTerm
            };

            var isStandard = data.length && data[0].label === searchTerm;

            // Add our "no-standard" node
            data = (isStandard ? [] : [noStandard]).concat(data);

            // Make the default selection auto select the
            // first standard:

            if (data.length > 1 && !isStandard) {
              data[0] = Object.assign({}, data[0], {
                id: data[1].id,
                standardText: data[1].standardText,
                standardLabel: data[1].label,
                julianDateRange: data[1].julianDateRange
              });
            }
            if (data.length > 1) {
              // Eliminate the "None of the Above" entry
              data = data.slice(0, data.length - 1);
            }

            return data;
          }.bind(this)).then(resolve).catch(reject);
        }.bind(this));
      },

      _getPlaceholder: function(type, datePlaceholder, placePlaceholder) {
        var string = '_i18n_' + type.toUpperCase() + '_PLACEHOLDER';
        return this[string];
      },

      _handleChange: function(e) {
        if(!e || !e.detail) return;
        this._searchTerm = e.detail.value;
        // we unset the standard whenever they change the the text
        this._standardLabel = '';
        this.standardText = null;
        this.standardId = '';
        this.julianDateRange = null;
        this.originalText = this._searchTerm;
        if (e.detail.value) this.$.typeahead.loading = true;
      },

      _handleChangeStandard: function(e) {
        if (!e || !e.model || !e.model.item) return;
        noneOfTheAboveText = this._options[this._options.length-1].standardLabel;
        if (this.originalText === this.standardText) {
          this._stopSearch = true;
          this.originalText = e.model.item.standardText || this.originalText;
          this._searchTerm = e.model.item.standardText || this._searchTerm;
        }
        this.standardId = e.model.item.id;
        this.standardText = e.model.item.standardText;
        this._standardLabel = e.model.item.standardLabel === noneOfTheAboveText ? this['_i18n_NO_STANDARD_SELECTED'] : e.model.item.standardLabel;
        this.julianDateRange = e.model.item.julianDateRange;
        this._hideStandards = true;
      },

      _handleSelect: function(e) {
        if (this.$.typeahead.loading) {
          // this is a hacky way to override the behavior in birch-typeahead
          // where on select it updates the input value - we can't intercept
          // that call, but this allows us to have the text appear correct to
          // the user. The _searchTerm is the value we just typed.
          this.$.typeahead.$.input.value = this._searchTerm;
          return;
        }
        if (!e || !e.detail || !e.detail.selection) return;
        if (this._searchTerm !== e.detail.selection.label) this._stopSearch = true;
        this.originalText = e.detail.selection.label;
        this._searchTerm = e.detail.selection.label;
        this.standardId = e.detail.selection.id;
        this.standardText = e.detail.selection.standardText;
        this._standardLabel = e.detail.selection.standardLabel;
        this.julianDateRange = e.detail.selection.julianDateRange;
      },

      _handleCancel: function(e) {
        if (this._searchTerm && !this._standardLabel) {
          if (this._options.length > 0) {
            this._standardLabel = this['_i18n_NO_STANDARD_SELECTED'];
          } else {
            this._standardLabel = this['_i18n_NO_STANDARD_' + this.standardType.toUpperCase() + '_AVAILABLE'];
          }
          this.originalText = this._searchTerm;
        }
      },

      _openStandardSelector: function() {
        if (this._options.length < 1) return;
        this._hideStandards = false;
        if (this._optionsChanged) this.$.optionsMenu.select(0);
        this._optionsChanged = false;
      },

      _handleBlur: function(e) {
        if (e) {
          if (this && this.$.optionsMenu && !this.$.optionsMenu.contains(e.relatedTarget)) {
            this._hideStandards = true;
          } else {
            this.$.button.focus();
          }
        }
      },

      _setIsDateOrPlace: function() {
        this.isDate = this.standardType === 'date';
        this.isPlace = this.standardType === 'place';
      },

      _handleKeydown: function(e) {
        if(!e || !e.which) return;
        switch(e.which){
          case 38:  this._handleUpArrow(e);     break;
          case 40:  this._handleDownArrow(e);   break;
          case 9:   this._handleTab(e);         break;
          case 13:  this._handleEnter(e);       break;
          case 27:  this._handleEscape(e);      break;
        }
      },

      _handleUpArrow: function(e) {
        if(this._hideStandards) return;
        e.preventDefault();
        var optionsMenu = this.$.optionsMenu;
        var index = Math.max(optionsMenu.selected - 1, 0);
        optionsMenu.select(index);
        this.$.button.focus();
      },

      _handleDownArrow: function(e) {
        if(this._hideStandards) {
          this._hideStandards = false;
          return;
        }
        e.preventDefault();
        var optionsMenu = this.$.optionsMenu;
        var index = 0;
        if(typeof optionsMenu.selected === 'number'){
          index = Math.min(optionsMenu.selected + 1, this._options.length - 1);
        }
        optionsMenu.select(index);
        this.$.button.focus();
      },

      _handleTab: function(e) {
        if(this._hideStandards) return;
        e.preventDefault();
        if (e.shiftKey) {
          this._handleUpArrow(e);
        } else {
          this._handleDownArrow(e);
        }
      },

      _handleEnter: function(e) {
        if(this._hideStandards) {
          this._hideStandards = false;
          return;
        }
        e.preventDefault();
        e.model = e.model || {};
        e.model.item = this._options[this.$.optionsMenu.selected];
        this._handleChangeStandard(e);
        this.$.button.focus();
      },

      _handleEscape: function(e) {
        this._hideStandards = true;
        this.$.button.focus();
      },

      _handleDownArrowForTypeahead: function(e) {
        if(e && e.which && e.which === 40 && this.$.typeahead._hideOptions) {
          if (this._optionstoUseWhenNoChange) {
            this.$.typeahead.options = this._optionstoUseWhenNoChange;
            this._optionstoUseWhenNoChange = null;
          } else {
            this.$.typeahead.showOptions();
          }
        }
      },

    });
  </script>
</dom-module>
